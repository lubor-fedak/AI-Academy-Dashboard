# On push to main: deploy ai-academy-dashboard to Vercel production via CLI
# Project has Root Directory = ai-academy-dashboard, so we deploy from repo root.
# Secrets: VERCEL_TOKEN, VERCEL_GIT_EMAIL (Vercel account email â€“ must have team access)

name: Vercel Deploy on Push

on:
  push:
    branches: [main]
  workflow_dispatch: {}   # allow manual run from Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show trigger
        run: |
          echo "Triggered by: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          git log -1 --format="Commit: %h %s"

      # Vercel CLI checks HEAD commit author; it must be a team member.
      # Create a local empty commit with the team email so deploy succeeds (do not push).
      - name: Set Git author for Vercel (must match team member)
        run: |
          git config user.email "${{ secrets.VERCEL_GIT_EMAIL }}"
          git config user.name "Vercel Deploy"
          git commit --allow-empty -m "ci: trigger Vercel deploy" --author="Vercel Deploy <${{ secrets.VERCEL_GIT_EMAIL }}>"

      - name: Deploy to Vercel
        env:
          VERCEL_ORG_ID: team_79xLIGLnrIoybEiGKxc17Pkq
          VERCEL_PROJECT_ID: prj_kjo9Q2mGffq6ybNjzszpJGDqPqQ5
        run: npx vercel deploy --prod --token "${{ secrets.VERCEL_TOKEN }}" --yes
